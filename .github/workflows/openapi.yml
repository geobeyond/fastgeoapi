name: Validate OpenAPI with Spectral

on:
  - push
  - pull_request

jobs:
  spectral-oas:
    name: Lint and validate OpenAPI document for pygeoapi configuration
    runs-on: ubuntu-latest
    steps:
      # Check out the repository
      - name: Check out the repository
        uses: actions/checkout@v6.0.1

      - name: Set up Python 3.12
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"

      - name: Upgrade pip
        run: |
          python -m pip install pip==25.1.1
          pip --version

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          version: "0.9.24"

      - name: Create OpenAPI with fastgeoapi CLI
        run: |
          uv pip install --system --break-system-packages -r pyproject.toml
          uv run fastgeoapi openapi
        env:
          UV_SYSTEM_PYTHON: 1
          UV_BREAK_SYSTEM_PACKAGES: 1
      # Display the OAS3 ruleset (already in repo)
      - name: Show OAS3 ruleset
        run: |
          cat .spectral.oas3.yaml

      # Run Spectral for OAS3 - highlights errors but doesn't fail the build
      - name: Run Spectral for OAS3
        uses: stoplightio/spectral-action@latest
        continue-on-error: true
        with:
          file_glob: "pygeoapi-openapi.json"
          spectral_ruleset: ".spectral.oas3.yaml"

  spectral-owasp:
    name: Validate OpenAPI document against OWASP Top 10 API security rules
    runs-on: ubuntu-latest
    steps:
      # Check out the repository
      - name: Check out the repository
        uses: actions/checkout@v6.0.1

      - name: Set up Python 3.12
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"

      - name: Upgrade pip
        run: |
          python -m pip install pip==25.1.1
          pip --version

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          version: "0.9.24"

      - name: Create OpenAPI with fastgeoapi CLI
        run: |
          uv pip install --system --break-system-packages -r pyproject.toml
          uv run fastgeoapi openapi
        env:
          UV_SYSTEM_PYTHON: 1
          UV_BREAK_SYSTEM_PACKAGES: 1
      # Install Spectral CLI for report generation
      - name: Install Spectral CLI
        run: |
          npm install -g @stoplight/spectral-cli @stoplight/spectral-owasp-ruleset@latest

      # Display the OWASP ruleset (already in repo with warning overrides)
      - name: Show OWASP ruleset
        run: |
          cat .spectral.owasp-top.10.yaml

      # Run Spectral action for GitHub annotations
      - name: Run Spectral for OWASP top 10
        uses: stoplightio/spectral-action@latest
        continue-on-error: true
        with:
          file_glob: "pygeoapi-openapi.json"
          spectral_ruleset: ".spectral.owasp-top.10.yaml"

      # Generate report for job summary
      - name: Generate OWASP report data
        if: always()
        run: |
          npx spectral lint pygeoapi-openapi.json \
            --ruleset .spectral.owasp-top.10.yaml \
            --format text > spectral-owasp-results.txt 2>&1 || true

      # Create OWASP Security Report summary
      - name: Generate OWASP Security Report
        if: always()
        run: |
          echo "# ðŸ”’ OWASP API Security Top 10 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f spectral-owasp-results.txt ] && [ -s spectral-owasp-results.txt ]; then
            ERROR_COUNT=$(grep -c " error " spectral-owasp-results.txt || echo "0")
            WARNING_COUNT=$(grep -c " warning " spectral-owasp-results.txt || echo "0")

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Errors | $ERROR_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Warnings | $WARNING_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "## Detailed Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand full report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat spectral-owasp-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No OWASP security issues found!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated by Spectral with OWASP API Security ruleset*" >> $GITHUB_STEP_SUMMARY
